<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rebbe Points - Professional Teacher Management System</title>
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/dzlhbhuua/image/upload/c_fill,g_auto,w_32,h_32,r_max/v1730151234/Rebbe_Points_Logo_Circle_hazw7v.png"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
   
    :root {
      --primary-color: #1ab5f4;
      --primary-dark: #1495c7;
      --secondary-color: #64748b;
      --success-color: #059669;
      --warning-color: #e7af26;
      --danger-color: #dc2626;
      --info-color: #0ea5e9;
      --background: #f8fafc;
      --surface: #ffffff;
      --surface-secondary: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --sidebar-width: 280px;
      --topbar-height: 70px;
    }
   
    * { margin: 0; padding: 0; box-sizing: border-box; }
   
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* Authentication Screen */
    .auth-screen {
      min-height: 100vh;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--warning-color) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      position: relative;
    }
   
    .auth-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 3rem;
      max-width: 480px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
    }
   
    .auth-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      text-align: center;
    }
   
    .auth-subtitle {
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 2rem;
    }
   
    .form-group {
      margin-bottom: 1.5rem;
    }
   
    .form-label {
      display: block;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
   
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
      background: var(--surface);
    }
   
    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgb(26 181 244 / 0.1);
    }
   
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }
   
    .btn-primary {
      background: var(--primary-color);
      color: var(--surface);
    }
   
    .btn-primary:hover {
      background: var(--primary-dark);
    }
   
    .btn-secondary {
      background: var(--secondary-color);
      color: var(--surface);
    }
   
    .btn-success {
      background: var(--success-color);
      color: var(--surface);
    }
   
    .btn-warning {
      background: var(--warning-color);
      color: var(--surface);
    }
   
    .btn-danger {
      background: var(--danger-color);
      color: var(--surface);
    }

    .btn-info {
      background: var(--info-color);
      color: var(--surface);
    }
   
    .btn-full {
      width: 100%;
      margin-bottom: 1rem;
    }
   
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
   
    .account-type-selection {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
   
    .account-type-btn {
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--surface);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-weight: 500;
    }
   
    .account-type-btn.active {
      border-color: var(--primary-color);
      background: rgb(26 181 244 / 0.05);
      color: var(--primary-color);
    }
   
    .auth-switch {
      color: var(--primary-color);
      cursor: pointer;
      text-decoration: underline;
    }
   
    .error-message, .success-message {
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      display: none;
    }
   
    .error-message {
      background: rgb(220 38 38 / 0.1);
      color: var(--danger-color);
      border: 1px solid rgb(220 38 38 / 0.2);
    }
   
    .success-message {
      background: rgb(5 150 105 / 0.1);
      color: var(--success-color);
      border: 1px solid rgb(5 150 105 / 0.2);
    }

    /* Corner Buttons */
    .corner-button {
      position: fixed;
      bottom: 1rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      color: var(--surface);
      text-decoration: none;
      z-index: 100;
    }

    .about-button {
      left: 1rem;
    }

    .how-to-use-button {
      right: 1rem;
    }

    /* Sidebar Layout */
    .app-layout {
      display: none;
      min-height: 100vh;
    }
   
    .app-layout.active {
      display: flex;
    }
   
    .sidebar {
      width: var(--sidebar-width);
      background: var(--surface);
      border-right: 1px solid var(--border-color);
      box-shadow: var(--shadow);
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
    }
   
    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
   
    .sidebar-logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
    }
   
    .sidebar-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
   
    .sidebar-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }
   
    .sidebar-nav {
      padding: 1rem 0;
    }
   
    .nav-section {
      margin-bottom: 2rem;
    }
   
    .nav-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0 1.5rem;
      margin-bottom: 0.75rem;
    }
   
    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      border-left: 3px solid transparent;
    }
   
    .nav-item:hover {
      background: var(--surface-secondary);
      color: var(--text-primary);
    }
   
    .nav-item.active {
      background: rgb(26 181 244 / 0.1);
      color: var(--primary-color);
      border-left-color: var(--primary-color);
    }
   
    .nav-icon {
      font-size: 1.25rem;
      width: 20px;
      text-align: center;
    }
   
    .sidebar-footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1.5rem;
      border-top: 1px solid var(--border-color);
      background: var(--surface);
    }
   
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
   
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-color);
      color: var(--surface);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
   
    .user-details h4 {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
    }
   
    .user-details p {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
   
    /* Main Content Area */
    .main-content {
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      width: calc(100% - var(--sidebar-width));
    }
   
    .topbar {
      height: var(--topbar-height);
      background: var(--surface);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 50;
    }
   
    .hamburger-menu {
      display: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      color: var(--text-primary);
    }
   
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
   
    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }
   
    .class-selector {
      min-width: 200px;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--surface);
    }
   
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
   
    .search-input {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      min-width: 250px;
      background: var(--surface);
    }
   
    .content-area {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }
   
    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
   
    .view-toggle {
      display: flex;
      background: var(--surface-secondary);
      border-radius: 8px;
      padding: 0.25rem;
    }
   
    .view-option {
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.2s;
    }
   
    .view-option.active {
      background: var(--surface);
      color: var(--text-primary);
      box-shadow: var(--shadow);
    }
   
    .action-buttons {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    /* Admin Styles */
    .admin-header {
      background: var(--surface);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }
   
    .admin-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
   
    .admin-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }
   
    .admin-content {
      background: var(--surface);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--surface-secondary);
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
    }

    /* Student Cards */
    .students-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .students-list {
      display: none;
      flex-direction: column;
      gap: 0.75rem;
    }

    .student-list-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--surface);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .student-list-item:hover {
      box-shadow: var(--shadow);
      background: var(--surface-secondary);
    }

    .student-list-item.selected {
      border-color: var(--primary-color);
      background: rgb(26 181 244 / 0.05);
    }

    .student-list-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--primary-color);
      color: var(--surface);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      overflow: hidden;
    }

    .student-list-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .student-list-info {
      flex: 1;
      min-width: 0;
    }

    .student-list-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .student-list-details {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .student-list-points {
      font-weight: 700;
      color: var(--primary-color);
      font-size: 1.125rem;
    }

    .student-list-actions {
      display: flex;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .student-list-item:hover .student-list-actions {
      opacity: 1;
    }
   
    .student-card {
      background: var(--surface);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.2s;
      cursor: pointer;
      position: relative;
    }
   
    .student-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .student-card.selected {
      border-color: var(--primary-color);
      background: rgb(26 181 244 / 0.05);
    }
   
    .student-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--primary-color);
      color: var(--surface);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0 auto 1rem;
      position: relative;
      overflow: hidden;
    }

    .student-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
   
    .student-name {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
   
    .student-points {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .student-rewards {
      font-size: 0.875rem;
      color: var(--success-color);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .student-instant-rewards {
      font-size: 0.875rem;
      color: var(--info-color);
      font-weight: 500;
    }
   
    .add-student-card {
      background: var(--surface-secondary);
      border: 2px dashed var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 180px;
      cursor: pointer;
      transition: all 0.2s;
    }
   
    .add-student-card:hover {
      border-color: var(--primary-color);
      background: rgb(26 181 244 / 0.05);
    }
   
    .add-student-icon {
      font-size: 2rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    /* Class Detail View */
    .class-detail-card {
      background: var(--surface);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      transition: all 0.2s;
    }

    .class-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1.5rem;
    }

    .class-detail-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .class-detail-teacher {
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    .class-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .class-stat {
      text-align: center;
      padding: 1rem;
      background: var(--surface-secondary);
      border-radius: 8px;
    }

    .class-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.25rem;
    }

    .class-stat-label {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .students-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .students-table th,
    .students-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .students-table th {
      font-weight: 600;
      color: var(--text-primary);
      background: var(--surface-secondary);
    }

    .students-table tbody tr:hover {
      background: var(--surface-secondary);
    }

    /* Rewards Section */
    .rewards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .reward-card {
      background: var(--surface);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.2s;
      position: relative;
    }

    .reward-card:hover {
      box-shadow: var(--shadow-lg);
    }

    .reward-card.instant-reward {
      border-left: 4px solid var(--info-color);
    }

    .reward-card.points-reward {
      border-left: 4px solid var(--success-color);
    }

    .reward-type-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .instant-badge {
      background: rgb(14 165 233 / 0.1);
      color: var(--info-color);
    }

    .points-badge {
      background: rgb(5 150 105 / 0.1);
      color: var(--success-color);
    }

    .reward-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }

    .reward-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .reward-points {
      background: var(--primary-color);
      color: var(--surface);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .reward-description {
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    .reward-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* Leaderboard */
    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--surface);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-bottom: 0.75rem;
    }
   
    .leaderboard-rank {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--surface);
      font-size: 0.875rem;
    }
   
    .rank-1 { background: var(--warning-color); }
    .rank-2 { background: #9ca3af; }
    .rank-3 { background: #f59e0b; }
    .leaderboard-rank:not(.rank-1):not(.rank-2):not(.rank-3) {
      background: var(--primary-color);
    }
   
    .leaderboard-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--primary-color);
      color: var(--surface);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      overflow: hidden;
    }

    .leaderboard-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
   
    .leaderboard-name {
      flex: 1;
      font-weight: 600;
      color: var(--text-primary);
    }
   
    .leaderboard-points {
      font-weight: 700;
      color: var(--primary-color);
    }

    /* Bulk Actions */
    .bulk-actions {
      display: none;
      background: rgb(26 181 244 / 0.1);
      border: 1px solid rgb(26 181 244 / 0.2);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
   
    .bulk-actions.active {
      display: flex;
    }
   
    .selected-count {
      font-weight: 600;
      color: var(--primary-color);
    }
   
    .bulk-point-input {
      width: 80px;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      text-align: center;
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      padding: 1rem;
    }
   
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
   
    .modal-content {
      background: var(--surface);
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-content.large {
      max-width: 800px;
    }
   
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
   
    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }
   
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0.25rem;
    }
   
    .modal-footer {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    /* File upload styles */
    .file-upload {
      display: none;
    }

    .upload-area {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 1rem;
    }

    .upload-area:hover {
      border-color: var(--primary-color);
      background: rgb(26 181 244 / 0.05);
    }

    .upload-area.dragover {
      border-color: var(--primary-color);
      background: rgb(26 181 244 / 0.1);
    }

    /* Reward Type Toggle */
    .reward-type-toggle {
      display: flex;
      background: var(--surface-secondary);
      border-radius: 8px;
      padding: 0.25rem;
      margin-bottom: 1.5rem;
    }

    .reward-type-option {
      flex: 1;
      padding: 0.75rem;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.2s;
      text-align: center;
    }

    .reward-type-option.active {
      background: var(--surface);
      color: var(--text-primary);
      box-shadow: var(--shadow);
    }

    /* Notification Styles */
    .notification {
      position: fixed;
      top: 2rem;
      right: 2rem;
      background: var(--surface);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      box-shadow: var(--shadow-lg);
      z-index: 1100;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      max-width: 400px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      border-left: 4px solid var(--success-color);
    }

    .notification.info {
      border-left: 4px solid var(--info-color);
    }

    .notification.warning {
      border-left: 4px solid var(--warning-color);
    }

    .notification.error {
      border-left: 4px solid var(--danger-color);
    }

    /* Fullscreen Embed Styles */
    .embed-container {
      position: relative;
    }

    .embed-container.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2000;
      background: var(--surface);
    }

    .fullscreen-button {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: var(--surface);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      font-size: 0.75rem;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
     
      .sidebar.mobile-open {
        transform: translateX(0);
      }
     
      .main-content {
        margin-left: 0;
        width: 100%;
      }
     
      .hamburger-menu {
        display: block;
      }
     
      .topbar {
        padding: 0 1rem;
      }
     
      .content-area {
        padding: 1rem;
      }
     
      .students-grid {
        grid-template-columns: 1fr;
      }
     
      .search-input {
        min-width: auto;
        width: 100%;
      }
     
      .content-header {
        flex-direction: column;
        align-items: stretch;
      }
     
      .action-buttons {
        justify-content: center;
      }

      .notification {
        top: 1rem;
        right: 1rem;
        left: 1rem;
        max-width: none;
      }

      .admin-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .class-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .corner-button {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
    }

    /* Utility Classes */
    .text-center { text-align: center; }
    .mb-1 { margin-bottom: 0.25rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 0.75rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mt-4 { margin-top: 1rem; }
    .hidden { display: none; }
    .relative { position: relative; }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div class="auth-screen" id="loginScreen">
    <div class="auth-card">
      <h1 class="auth-title">Welcome Back</h1>
      <p class="auth-subtitle">Sign in to access your classroom management system</p>
     
      <div class="error-message" id="loginError"></div>
     
      <div class="form-group">
        <label class="form-label" for="loginUsername">Username</label>
        <input type="text" class="form-input" id="loginUsername" placeholder="Enter your username"/>
      </div>
     
      <div class="form-group">
        <label class="form-label" for="loginPassword">Password</label>
        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password"/>
      </div>
     
      <button class="btn btn-primary btn-full" id="loginBtn">Sign In</button>
     
      <p class="text-center">Don't have an account? <a href="#" class="auth-switch" onclick="showSignup()">Create one here</a></p>
    </div>
    <a href="#" class="corner-button about-button btn btn-info" onclick="openAboutModal()">About</a>
    <a href="#" class="corner-button how-to-use-button btn btn-info" onclick="openHowToUseModal()">How to Use</a>
  </div>

  <!-- Signup Screen -->
  <div class="auth-screen" id="signupScreen" style="display: none;">
    <div class="auth-card">
      <h1 class="auth-title">Create Account</h1>
      <p class="auth-subtitle">Join our teacher management platform</p>
     
      <div class="error-message" id="signupError"></div>
      <div class="success-message" id="signupSuccess"></div>
     
      <div class="account-type-selection">
        <button type="button" class="account-type-btn active" data-type="personal" onclick="selectAccountType('personal')">
          <div>👨‍🏫 Teacher</div>
          <small>Personal classroom</small>
        </button>
        <button type="button" class="account-type-btn" data-type="admin" onclick="selectAccountType('admin')">
          <div>🏫 Administrator</div>
          <small>School management</small>
        </button>
      </div>
     
      <div class="form-group">
        <label class="form-label" for="signupUsername">Username</label>
        <input type="text" class="form-input" id="signupUsername" placeholder="Choose a username"/>
      </div>
     
      <div class="form-group">
        <label class="form-label" for="signupPassword">Password</label>
        <input type="password" class="form-input" id="signupPassword" placeholder="Choose a secure password"/>
      </div>
     
      <div class="form-group">
        <label class="form-label" for="signupConfirmPassword">Confirm Password</label>
        <input type="password" class="form-input" id="signupConfirmPassword" placeholder="Confirm your password"/>
      </div>
     
      <div class="form-group">
        <label class="form-label" for="signupSchool">School Name</label>
        <input type="text" class="form-input" id="signupSchool" placeholder="Enter your school name"/>
      </div>
     
      <button class="btn btn-primary btn-full" id="signupBtn">Create Account</button>
     
      <p class="text-center">Already have an account? <a href="#" class="auth-switch" onclick="showLogin()">Sign in here</a></p>
    </div>
    <a href="#" class="corner-button about-button btn btn-info" onclick="openAboutModal()">About</a>
    <a href="#" class="corner-button how-to-use-button btn btn-info" onclick="openHowToUseModal()">How to Use</a>
  </div>

  <!-- Main App Layout -->
  <div class="app-layout" id="appLayout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img src="https://res.cloudinary.com/dzlhbhuua/image/upload/c_fill,g_auto,w_40,h_40,r_max/v1730151234/Rebbe_Points_Logo_Circle_hazw7v.png" alt="Rebbe Points Logo"/>
        </div>
        <div class="sidebar-title">Rebbe Points</div>
      </div>
     
      <nav class="sidebar-nav">
        <!-- Dynamic nav items will be loaded here -->
      </nav>
     
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="sidebarUserAvatar">T</div>
          <div class="user-details">
            <h4 id="sidebarUsername">Teacher</h4>
            <p id="sidebarSchool">School Name</p>
          </div>
        </div>
        <button class="btn btn-warning" onclick="logout()" style="width: 100%; font-size: 0.875rem;">
          <span>🚪</span> Sign Out
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Bar -->
      <header class="topbar">
        <div class="topbar-left">
          <span class="hamburger-menu" onclick="toggleSidebar()">☰</span>
          <h1 class="page-title" id="pageTitle">Students</h1>
          <select class="class-selector" id="classSelector"></select>
          <button class="btn btn-info" style="padding: 0.5rem 1rem;" onclick="copyClassName()">Copy Class Name</button>
        </div>
        <div class="topbar-right">
          <input type="text" class="search-input" id="searchInput" placeholder="Search students..." oninput="onSearchChange()"/>
          <button class="btn btn-primary" onclick="openNewClassModal()">New Class</button>
        </div>
      </header>

      <!-- Content Area -->
      <div class="content-area">
        <!-- Bulk Actions -->
        <div class="bulk-actions" id="bulkActions">
          <span class="selected-count" id="selectedCount">0 selected</span>
          <label>Points: <input type="number" class="bulk-point-input" id="bulkPointAmount" value="1" min="1"/></label>
          <button class="btn btn-success" onclick="openBulkPointsModal('add')">Add Points</button>
          <button class="btn btn-warning" onclick="openBulkPointsModal('subtract')">Subtract Points</button>
          <button class="btn btn-secondary" onclick="exitBulkMode()">Cancel</button>
        </div>

        <!-- Students View -->
        <div id="studentsView">
          <div class="content-header">
            <div class="view-toggle">
              <button class="view-option active" data-view="grid" onclick="switchStudentView(event, 'grid')">Grid View</button>
              <button class="view-option" data-view="list" onclick="switchStudentView(event, 'list')">List View</button>
            </div>
            <div class="action-buttons">
              <button class="btn btn-success" onclick="openAddStudentModal()">Add Student</button>
              <button class="btn btn-success" onclick="openAddMultipleModal()">Add Multiple</button>
              <button class="btn btn-secondary" onclick="enterBulkMode()">Bulk Actions</button>
            </div>
          </div>
         
          <div class="students-grid" id="studentsGrid">
            <div class="student-card add-student-card" onclick="openAddStudentModal()">
              <div class="add-student-icon">➕</div>
              <div>Add New Student</div>
            </div>
          </div>

          <div class="students-list" id="studentsList"></div>
        </div>

        <!-- Leaderboard View -->
        <div id="leaderboardView" style="display:none;">
          <div class="content-header">
            <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Class Leaderboard</h2>
          </div>
          <div class="leaderboard" id="leaderboard"></div>
        </div>

        <!-- Rewards View -->
        <div id="rewardsView" style="display:none;">
          <div class="content-header">
            <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Class Rewards</h2>
            <div class="action-buttons">
              <button class="btn btn-primary" onclick="openCreateRewardModal()">Create Reward</button>
            </div>
          </div>
          <div class="rewards-grid" id="rewardsGrid"></div>
        </div>

        <!-- History View -->
        <div id="historyView" style="display:none;">
          <div class="content-header">
            <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Points History</h2>
            <div class="action-buttons">
              <button class="btn btn-info" onclick="exportHistory()">Export History</button>
              <button class="btn btn-warning" onclick="clearHistory()">Clear History</button>
            </div>
          </div>
          <div id="historyList" style="max-height: 70vh; overflow-y: auto;"></div>
        </div>

        <!-- Settings View -->
        <div id="settingsView" style="display:none;">
          <div class="content-header">
            <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Settings</h2>
          </div>
         
          <div style="display: grid; gap: 2rem;">
            <div style="background: var(--surface); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color);">
              <h3 style="margin-bottom: 1rem; color: var(--text-primary);">User Information</h3>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Username:</span>
                <span id="settingsUsername" style="font-weight: 600;"></span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>School:</span>
                <span id="settingsSchool" style="font-weight: 600;"></span>
              </div>
            </div>
           
            <div style="background: var(--surface); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color);">
              <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Class Statistics</h3>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Current Class:</span>
                <span id="currentClassName" style="font-weight: 600;"></span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Total Students:</span>
                <span id="totalStudents" style="font-weight: 600;">0</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <span>Total Points Awarded:</span>
                <span id="totalPoints" style="font-weight: 600;">0</span>
              </div>
              <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-warning" onclick="resetAllPoints()">Reset All Points</button>
                <button class="btn btn-info" onclick="backupClassData()">Backup Data</button>
              </div>
            </div>
           
            <div style="background: var(--surface); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color);">
              <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Saved Reasons</h3>
              <div id="savedReasonsList" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
            </div>
           
            <div style="background: rgb(220 38 38 / 0.1); padding: 2rem; border-radius: 12px; border: 1px solid rgb(220 38 38 / 0.2);">
              <h3 style="margin-bottom: 1rem; color: var(--danger-color);">Danger Zone</h3>
              <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                This action cannot be undone. This will permanently delete the current class and all student data.
              </p>
              <button class="btn btn-danger" onclick="deleteCurrentClass()">Delete Current Class</button>
            </div>
          </div>
        </div>
        
        <!-- Extras View -->
        <div id="extrasView" style="display:none;">
          <div class="content-header">
            <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Extras</h2>
          </div>
          <div id="embedsList"></div>
        </div>

        <!-- Power Ups View -->
        <div id="powerupsView" style="display:none;">
          <div class="content-header">
            <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Power Ups</h2>
            <div class="action-buttons">
              <button class="btn btn-primary" onclick="openCreatePowerUpModal()">Create Power Up</button>
            </div>
          </div>
          <div class="rewards-grid" id="powerupsGrid"></div>
        </div>

      </div>
    </main>
  </div>

  <!-- Modals -->
 
  <!-- About Modal -->
  <div class="modal" id="aboutModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">About Rebbe Points</h2>
        <button class="modal-close" onclick="closeModal('aboutModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Rebbe Points is a professional teacher management system designed to help teachers manage classrooms, track student points, rewards, and more.</p>
        <p>Developed with care for educational excellence. Version 1.0.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('aboutModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- How to Use Modal -->
  <div class="modal" id="howToUseModal">
    <div class="modal-content large">
      <div class="modal-header">
        <h2 class="modal-title">How to Use Rebbe Points</h2>
        <button class="modal-close" onclick="closeModal('howToUseModal')">&times;</button>
      </div>
      <div class="modal-body">
        <h3>Getting Started</h3>
        <p>1. Sign up or log in using your credentials.</p>
        <p>2. Create a class or select an existing one from the dropdown.</p>
        <h3>Managing Students</h3>
        <p>- Add students individually or in bulk.</p>
        <p>- Award or subtract points with reasons.</p>
        <p>- Use bulk actions for multiple students.</p>
        <h3>Rewards and Leaderboard</h3>
        <p>- Create rewards (points-based or instant).</p>
        <p>- View leaderboard for top students.</p>
        <h3>History and Settings</h3>
        <p>- Track all point changes in history.</p>
        <p>- Manage settings, reset points, or delete classes in the danger zone.</p>
        <h3>Admin Features (if applicable)</h3>
        <p>- Create classes and teacher accounts.</p>
        <p>- Manage embeds and school-wide data.</p>
        <p>For more details, explore the sidebar navigation.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('howToUseModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Create Class Modal (Admin) -->
  <div class="modal" id="createClassModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create New Class</h2>
        <button class="modal-close" onclick="closeModal('createClassModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="adminClassName">Class Name</label>
          <input type="text" class="form-input" id="adminClassName" placeholder="e.g., Grade 6B, Science Class..." maxlength="50"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="teacherUsername">Teacher Username</label>
          <input type="text" class="form-input" id="teacherUsername" placeholder="Username for the teacher login"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="teacherPassword">Teacher Password</label>
          <input type="password" class="form-input" id="teacherPassword" placeholder="Password for the teacher login"/>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('createClassModal')">Cancel</button>
        <button class="btn btn-primary" onclick="createClassAsAdmin()">Create Class & Teacher Account</button>
      </div>
    </div>
  </div>

  <!-- Class Detail Modal (Admin) -->
  <div class="modal" id="classDetailModal">
    <div class="modal-content large">
      <div class="modal-header">
        <h2 class="modal-title" id="classDetailTitle">Class Details</h2>
        <button class="modal-close" onclick="closeModal('classDetailModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="classDetailContent"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('classDetailModal')">Close</button>
        <button class="btn btn-danger" id="deleteClassBtn" onclick="deleteClassFromDetail()">Delete Class</button>
      </div>
    </div>
  </div>

  <!-- Edit Teacher Modal (Admin) -->
  <div class="modal" id="editTeacherModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Teacher</h2>
        <button class="modal-close" onclick="closeModal('editTeacherModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="editTeacherUsername">Username</label>
          <input type="text" class="form-input" id="editTeacherUsername"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="editTeacherPassword">New Password</label>
          <input type="password" class="form-input" id="editTeacherPassword" placeholder="Enter new password"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="editTeacherConfirmPassword">Confirm New Password</label>
          <input type="password" class="form-input" id="editTeacherConfirmPassword" placeholder="Confirm new password"/>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('editTeacherModal')">Cancel</button>
        <button class="btn btn-primary" onclick="updateTeacher()">Update</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Embed Modal (Admin) -->
  <div class="modal" id="addEmbedModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add Embed</h2>
        <button class="modal-close" onclick="closeModal('addEmbedModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="embedName">Name</label>
          <input type="text" class="form-input" id="embedName" placeholder="Enter embed name"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="embedUrl">URL</label>
          <input type="url" class="form-input" id="embedUrl" placeholder="Enter embed URL"/>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addEmbedModal')">Cancel</button>
        <button class="btn btn-primary" onclick="addEmbed()">Add</button>
      </div>
    </div>
  </div>

  <!-- New Class Modal -->
  <div class="modal" id="newClassModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create New Class</h2>
        <button class="modal-close" onclick="closeModal('newClassModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="newClassName">Class Name</label>
          <input type="text" class="form-input" id="newClassName" placeholder="e.g., Grade 6B, Science Class..." maxlength="50"/>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('newClassModal')">Cancel</button>
        <button class="btn btn-primary" onclick="createNewClass()">Create Class</button>
      </div>
    </div>
  </div>

  <!-- Add Student Modal -->
  <div class="modal" id="addStudentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add New Student</h2>
        <button class="modal-close" onclick="closeModal('addStudentModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="studentName">Student Name</label>
          <input type="text" class="form-input" id="studentName" placeholder="Enter student's full name..." maxlength="50"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="initialPoints">Starting Points (optional)</label>
          <input type="number" class="form-input" id="initialPoints" value="0" min="0"/>
        </div>
        <div class="form-group">
          <label class="form-label">Profile Picture (optional)</label>
          <div class="upload-area" onclick="document.getElementById('studentPhoto').click()">
            <p>📷 Click to upload or drag image here</p>
            <small>Supports JPG, PNG, GIF (max 5MB)</small>
          </div>
          <input type="file" id="studentPhoto" class="file-upload" accept="image/*"/>
          <div id="photoPreview" style="display: none; text-align: center; margin-top: 1rem;">
            <img id="previewImg" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color);"/>
            <br>
            <button type="button" class="btn btn-secondary" style="margin-top: 0.5rem; font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="removePhoto()">Remove Photo</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addStudentModal')">Cancel</button>
        <button class="btn btn-success" onclick="addStudent()">Add Student</button>
      </div>
    </div>
  </div>

  <!-- Add Multiple Students Modal -->
  <div class="modal" id="addMultipleModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add Multiple Students</h2>
        <button class="modal-close" onclick="closeModal('addMultipleModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="multipleNames">Student Names (one per line)</label>
          <textarea class="form-input" id="multipleNames" rows="10" placeholder="John Doe&#10;Jane Smith&#10;..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addMultipleModal')">Cancel</button>
        <button class="btn btn-success" onclick="addMultipleStudents()">Add Students</button>
      </div>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div class="modal" id="editStudentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Student</h2>
        <button class="modal-close" onclick="closeModal('editStudentModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="editStudentName">Student Name</label>
          <input type="text" class="form-input" id="editStudentName" placeholder="Enter student's full name..." maxlength="50"/>
        </div>
        <div class="form-group">
          <label class="form-label">Profile Picture (optional)</label>
          <div class="upload-area" onclick="document.getElementById('editStudentPhoto').click()">
            <p>📷 Click to upload or drag image here</p>
            <small>Supports JPG, PNG, GIF (max 5MB)</small>
          </div>
          <input type="file" id="editStudentPhoto" class="file-upload" accept="image/*"/>
          <div id="editPhotoPreview" style="display: none; text-align: center; margin-top: 1rem;">
            <img id="editPreviewImg" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color);"/>
            <br>
            <button type="button" class="btn btn-secondary" style="margin-top: 0.5rem; font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="removeEditPhoto()">Remove Photo</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('editStudentModal')">Cancel</button>
        <button class="btn btn-primary" onclick="updateStudent()">Update</button>
        <button class="btn btn-danger" onclick="deleteStudent()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Student Points Modal -->
  <div class="modal" id="studentPointsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="studentModalTitle">Add Points</h2>
        <button class="modal-close" onclick="closeModal('studentPointsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="pointsChange">Points</label>
          <input type="number" class="form-input" id="pointsChange" placeholder="Enter points amount" min="1"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="pointsReason">Reason</label>
          <input type="text" class="form-input" id="pointsReason" placeholder="e.g., Excellent participation" list="reasonsList"/>
          <datalist id="reasonsList"></datalist>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('studentPointsModal')">Cancel</button>
        <button class="btn btn-primary" onclick="updateStudentPoints()">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Bulk Points Modal -->
  <div class="modal" id="bulkPointsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="bulkModalTitle">Add Points</h2>
        <button class="modal-close" onclick="closeModal('bulkPointsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p id="bulkSummary"></p>
        <div class="form-group">
          <label class="form-label" for="bulkReason">Reason</label>
          <input type="text" class="form-input" id="bulkReason" placeholder="e.g., Group activity" list="reasonsList"/>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('bulkPointsModal')">Cancel</button>
        <button class="btn btn-primary" onclick="confirmBulkPoints()">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Create Reward Modal -->
  <div class="modal" id="createRewardModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Reward</h2>
        <button class="modal-close" onclick="closeModal('createRewardModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="reward-type-toggle">
          <button class="reward-type-option active" data-type="points" onclick="selectRewardType('points')">Points Reward</button>
          <button class="reward-type-option" data-type="instant" onclick="selectRewardType('instant')">Instant Reward</button>
        </div>
        <div class="form-group">
          <label class="form-label" for="rewardTitle">Reward Title</label>
          <input type="text" class="form-input" id="rewardTitle" placeholder="e.g., Homework Pass"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="rewardDescription">Description (optional)</label>
          <textarea class="form-input" id="rewardDescription" rows="4" placeholder="Describe the reward..."></textarea>
        </div>
        <div class="form-group" id="rewardPointsGroup">
          <label class="form-label" for="rewardPoints">Points Required</label>
          <input type="number" class="form-input" id="rewardPoints" placeholder="e.g., 100" min="1"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="rewardIcon">Icon (optional)</label>
          <input type="text" class="form-input" id="rewardIcon" placeholder="e.g., 🎉"/>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('createRewardModal')">Cancel</button>
        <button class="btn btn-primary" onclick="createReward()">Create</button>
      </div>
    </div>
  </div>

  <!-- Edit Reward Modal -->
  <div class="modal" id="editRewardModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Reward</h2>
        <button class="modal-close" onclick="closeModal('editRewardModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="reward-type-toggle">
          <button class="reward-type-option active" data-type="points" onclick="selectRewardType('points', 'edit')">Points Reward</button>
          <button class="reward-type-option" data-type="instant" onclick="selectRewardType('instant', 'edit')">Instant Reward</button>
        </div>
        <div class="form-group">
          <label class="form-label" for="editRewardTitle">Reward Title</label>
          <input type="text" class="form-input" id="editRewardTitle" placeholder="e.g., Homework Pass"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="editRewardDescription">Description (optional)</label>
          <textarea class="form-input" id="editRewardDescription" rows="4" placeholder="Describe the reward..."></textarea>
        </div>
        <div class="form-group" id="editRewardPointsGroup">
          <label class="form-label" for="editRewardPoints">Points Required</label>
          <input type="number" class="form-input" id="editRewardPoints" placeholder="e.g., 100" min="1"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="editRewardIcon">Icon (optional)</label>
          <input type="text" class="form-input" id="editRewardIcon" placeholder="e.g., 🎉"/>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('editRewardModal')">Cancel</button>
        <button class="btn btn-primary" onclick="updateReward()">Update</button>
        <button class="btn btn-danger" onclick="deleteReward()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Claim Reward Modal -->
  <div class="modal" id="claimRewardModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Claim Reward</h2>
        <button class="modal-close" onclick="closeModal('claimRewardModal')">&times;</button>
      </div>
      <div class="modal-body" id="claimRewardContent"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('claimRewardModal')">Cancel</button>
        <button class="btn btn-primary" onclick="confirmClaimReward()">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Create Power Up Modal -->
  <div class="modal" id="createPowerUpModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Power Up</h2>
        <button class="modal-close" onclick="closeModal('createPowerUpModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="powerUpTitle">Power Up Title</label>
          <input type="text" class="form-input" id="powerUpTitle" placeholder="e.g., Double Points Week"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="powerUpDescription">Description (optional)</label>
          <textarea class="form-input" id="powerUpDescription" rows="4" placeholder="Describe the power up..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label" for="powerUpMultiplier">Points Multiplier</label>
          <input type="number" class="form-input" id="powerUpMultiplier" placeholder="e.g., 2" min="1" step="0.1"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="powerUpDuration">Duration (days)</label>
          <input type="number" class="form-input" id="powerUpDuration" placeholder="e.g., 7" min="1"/>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('createPowerUpModal')">Cancel</button>
        <button class="btn btn-primary" onclick="createPowerUp()">Create</button>
      </div>
    </div>
  </div>

  <!-- Edit Power Up Modal -->
  <div class="modal" id="editPowerUpModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Power Up</h2>
        <button class="modal-close" onclick="closeModal('editPowerUpModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="editPowerUpTitle">Power Up Title</label>
          <input type="text" class="form-input" id="editPowerUpTitle" placeholder="e.g., Double Points Week"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="editPowerUpDescription">Description (optional)</label>
          <textarea class="form-input" id="editPowerUpDescription" rows="4" placeholder="Describe the power up..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label" for="editPowerUpMultiplier">Points Multiplier</label>
          <input type="number" class="form-input" id="editPowerUpMultiplier" placeholder="e.g., 2" min="1" step="0.1"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="editPowerUpDuration">Duration (days)</label>
          <input type="number" class="form-input" id="editPowerUpDuration" placeholder="e.g., 7" min="1"/>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('editPowerUpModal')">Cancel</button>
        <button class="btn btn-primary" onclick="updatePowerUp()">Update</button>
        <button class="btn btn-danger" onclick="deletePowerUp()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <script>
    let currentUser = null;
    let currentClassId = null;
    let currentTeacherUsername = null;
    let currentStudentId = null;
    let currentRewardId = null;
    let currentPowerUpId = null;
    let currentEmbedId = null;
    let selectedAccountType = 'personal';
    let selectedRewardType = 'points';
    let bulkMode = false;
    let bulkAction = 'add';
    let currentViewMode = 'grid';
    const users = {};
    const userData = {};
    const schools = {};
    let classes = [];
    let students = {};
    let history = {};
    let rewards = {};
    let powerups = {};
    let reasons = {};
    const selectedStudents = new Set();

    function generateId() {
      return Math.random().toString(36).substr(2, 9);
    }

    function sanitizeHTML(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showLogin() {
      document.getElementById('signupScreen').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
    }

    function showSignup() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('
      showSignup()">Sign Up</a></p>
    </div>
    <a href="#" class="corner-button about-button btn btn-info" onclick="openAboutModal()">About</a>
    <a href="#" class="corner-button how-to-use-button btn btn-info" onclick="openHowToUseModal()">How to Use</a>
  </div>
</div>

<!-- ... (previous HTML content remains unchanged) ... -->

<script>
// ... (previous JavaScript variables and functions up to showSignup) ...

function showSignup() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('signupScreen').style.display = 'flex';
}

function selectAccountType(type) {
  selectedAccountType = type;
  document.querySelectorAll('.account-type-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.type === type);
  });
}

function selectRewardType(type, context = 'create') {
  selectedRewardType = type;
  const toggle = context === 'create' ? '.reward-type-toggle' : '.reward-type-toggle';
  document.querySelectorAll(`${toggle} .reward-type-option`).forEach(btn => {
    btn.classList.toggle('active', btn.dataset.type === type);
  });
  if (context === 'create') {
    document.getElementById('rewardPointsGroup').style.display = type === 'points' ? 'block' : 'none';
  } else {
    document.getElementById('editRewardPointsGroup').style.display = type === 'points' ? 'block' : 'none';
  }
}

function showNotification(message, type = 'info') {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = `notification ${type} show`;
  setTimeout(() => {
    notification.className = `notification ${type}`;
  }, 3000);
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
  if (modalId === 'addStudentModal' || modalId === 'editStudentModal') {
    resetPhotoUpload(modalId === 'addStudentModal' ? 'studentPhoto' : 'editStudentPhoto');
  }
}

function openAboutModal() {
  document.getElementById('aboutModal').classList.add('active');
}

function openHowToUseModal() {
  document.getElementById('howToUseModal').classList.add('active');
}

function openNewClassModal() {
  document.getElementById('newClassModal').classList.add('active');
  document.getElementById('newClassName').value = '';
}

function openAddStudentModal() {
  document.getElementById('addStudentModal').classList.add('active');
  document.getElementById('studentName').value = '';
  document.getElementById('initialPoints').value = '0';
  resetPhotoUpload('studentPhoto');
}

function openAddMultipleModal() {
  document.getElementById('addMultipleModal').classList.add('active');
  document.getElementById('multipleNames').value = '';
}

function openCreateRewardModal() {
  document.getElementById('createRewardModal').classList.add('active');
  document.getElementById('rewardTitle').value = '';
  document.getElementById('rewardDescription').value = '';
  document.getElementById('rewardPoints').value = '';
  document.getElementById('rewardIcon').value = '';
  selectRewardType('points');
}

function openCreatePowerUpModal() {
  document.getElementById('createPowerUpModal').classList.add('active');
  document.getElementById('powerUpTitle').value = '';
  document.getElementById('powerUpDescription').value = '';
  document.getElementById('powerUpMultiplier').value = '1';
  document.getElementById('powerUpDuration').value = '7';
}

function resetPhotoUpload(inputId) {
  const input = document.getElementById(inputId);
  input.value = '';
  const previewId = inputId === 'studentPhoto' ? 'photoPreview' : 'editPhotoPreview';
  document.getElementById(previewId).style.display = 'none';
}

function removePhoto() {
  resetPhotoUpload('studentPhoto');
}

function removeEditPhoto() {
  resetPhotoUpload('editStudentPhoto');
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('mobile-open');
}

function switchStudentView(event, view) {
  currentViewMode = view;
  document.querySelectorAll('.view-option').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.view === view);
  });
  document.getElementById('studentsGrid').style.display = view === 'grid' ? 'grid' : 'none';
  document.getElementById('studentsList').style.display = view === 'list' ? 'flex' : 'none';
}

function enterBulkMode() {
  bulkMode = true;
  selectedStudents.clear();
  document.getElementById('bulkActions').classList.add('active');
  updateSelectedCount();
  updateStudentsView();
}

function exitBulkMode() {
  bulkMode = false;
  selectedStudents.clear();
  document.getElementById('bulkActions').classList.remove('active');
  updateStudentsView();
}

function updateSelectedCount() {
  document.getElementById('selectedCount').textContent = `${selectedStudents.size} selected`;
}

function login() {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  const error = document.getElementById('loginError');

  if (!username || !password) {
    error.style.display = 'block';
    error.textContent = 'Please fill in all fields.';
    return;
  }

  if (users[username] && users[username].password === password) {
    currentUser = users[username];
    currentTeacherUsername = username;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appLayout').classList.add('active');
    initializeApp();
  } else {
    error.style.display = 'block';
    error.textContent = 'Invalid username or password.';
  }
}

function signup() {
  const username = document.getElementById('signupUsername').value.trim();
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('signupConfirmPassword').value;
  const school = document.getElementById('signupSchool').value.trim();
  const error = document.getElementById('signupError');
  const success = document.getElementById('signupSuccess');

  error.style.display = 'none';
  success.style.display = 'none';

  if (!username || !password || !confirmPassword || !school) {
    error.style.display = 'block';
    error.textContent = 'Please fill in all fields.';
    return;
  }

  if (password !== confirmPassword) {
    error.style.display = 'block';
    error.textContent = 'Passwords do not match.';
    return;
  }

  if (users[username]) {
    error.style.display = 'block';
    error.textContent = 'Username already exists.';
    return;
  }

  users[username] = {
    password,
    school,
    type: selectedAccountType,
    classes: []
  };
  userData[username] = { classes: {} };
  schools[school] = schools[school] || { classes: [], admins: [] };
  if (selectedAccountType === 'admin') {
    schools[school].admins.push(username);
  }

  success.style.display = 'block';
  success.textContent = 'Account created successfully! Redirecting to login...';
  setTimeout(showLogin, 2000);
}

function logout() {
  currentUser = null;
  currentClassId = null;
  currentTeacherUsername = null;
  document.getElementById('appLayout').classList.remove('active');
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginUsername').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginError').style.display = 'none';
}

function initializeApp() {
  updateSidebar();
  updateClassSelector();
  updateUserInfo();
  if (currentUser.type === 'admin') {
    showAdminView();
  } else {
    switchView('students');
    if (classes.length > 0) {
      currentClassId = classes[0].id;
      updateClassSelector();
      updateStudentsView();
      updateLeaderboard();
      updateRewardsView();
      updateHistoryView();
      updateSettingsView();
      updatePowerUpsView();
    }
  }
}

function updateSidebar() {
  const nav = document.querySelector('.sidebar-nav');
  nav.innerHTML = '';
  const isAdmin = currentUser.type === 'admin';
  const sections = isAdmin ? [
    {
      title: 'Admin',
      items: [
        { name: 'Classes', icon: '🏫', view: 'admin-classes', action: () => switchView('admin-classes') },
        { name: 'Teachers', icon: '👨‍🏫', view: 'admin-teachers', action: () => switchView('admin-teachers') },
        { name: 'Embeds', icon: '🔗', view: 'admin-embeds', action: () => switchView('admin-embeds') }
      ]
    }
  ] : [
    {
      title: 'Classroom',
      items: [
        { name: 'Students', icon: '👨‍🎓', view: 'students', action: () => switchView('students') },
        { name: 'Leaderboard', icon: '🏆', view: 'leaderboard', action: () => switchView('leaderboard') },
        { name: 'Rewards', icon: '🎁', view: 'rewards', action: () => switchView('rewards') },
        { name: 'History', icon: '📜', view: 'history', action: () => switchView('history') },
        { name: 'Settings', icon: '⚙️', view: 'settings', action: () => switchView('settings') },
        { name: 'Extras', icon: '✨', view: 'extras', action: () => switchView('extras') },
        { name: 'Power Ups', icon: '🚀', view: 'powerups', action: () => switchView('powerups') }
      ]
    }
  ];

  sections.forEach(section => {
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'nav-section';
    sectionDiv.innerHTML = `<div class="nav-section-title">${section.title}</div>`;
    section.items.forEach(item => {
      const navItem = document.createElement('div');
      navItem.className = `nav-item ${item.view === 'students' && !isAdmin ? 'active' : ''}`;
      navItem.innerHTML = `<span class="nav-icon">${item.icon}</span>${item.name}`;
      navItem.onclick = item.action;
      sectionDiv.appendChild(navItem);
    });
    nav.appendChild(sectionDiv);
  });
}

function switchView(view) {
  const views = ['students', 'leaderboard', 'rewards', 'history', 'settings', 'extras', 'powerups', 'admin-classes', 'admin-teachers', 'admin-embeds'];
  views.forEach(v => {
    document.getElementById(`${v}View`).style.display = v === view ? 'block' : 'none';
  });
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.toggle('active', item.textContent.includes(view.replace('admin-', '').replace(/s$/, '').charAt(0).toUpperCase() + view.replace('admin-', '').replace(/s$/, '').slice(1)));
  });
  document.getElementById('pageTitle').textContent = view.replace('admin-', '').replace(/s$/, '').charAt(0).toUpperCase() + view.replace('admin-', '').replace(/s$/, '').slice(1);
  if (view.startsWith('admin-')) {
    showAdminView();
  }
}

function updateClassSelector() {
  const selector = document.getElementById('classSelector');
  selector.innerHTML = '';
  classes = currentUser.classes.map(id => userData[currentTeacherUsername].classes[id]);
  classes.forEach(cls => {
    const option = document.createElement('option');
    option.value = cls.id;
    option.textContent = cls.name;
    if (cls.id === currentClassId) option.selected = true;
    selector.appendChild(option);
  });
  selector.onchange = () => {
    currentClassId = selector.value;
    updateStudentsView();
    updateLeaderboard();
    updateRewardsView();
    updateHistoryView();
    updateSettingsView();
    updatePowerUpsView();
  };
}

function updateUserInfo() {
  document.getElementById('sidebarUsername').textContent = currentTeacherUsername;
  document.getElementById('sidebarSchool').textContent = currentUser.school;
  document.getElementById('sidebarUserAvatar').textContent = currentTeacherUsername.charAt(0).toUpperCase();
  document.getElementById('settingsUsername').textContent = currentTeacherUsername;
  document.getElementById('settingsSchool').textContent = currentUser.school;
}

function createNewClass() {
  const className = document.getElementById('newClassName').value.trim();
  if (!className) {
    showNotification('Please enter a class name.', 'error');
    return;
  }
  const classId = generateId();
  userData[currentTeacherUsername].classes[classId] = {
    id: classId,
    name: className,
    students: [],
    rewards: [],
    history: [],
    powerups: [],
    reasons: []
  };
  currentUser.classes.push(classId);
  classes.push({ id: classId, name: className });
  students[classId] = [];
  rewards[classId] = [];
  history[classId] = [];
  powerups[classId] = [];
  reasons[classId] = [];
  currentClassId = classId;
  updateClassSelector();
  updateStudentsView();
  updateLeaderboard();
  updateRewardsView();
  updateHistoryView();
  updateSettingsView();
  updatePowerUpsView();
  closeModal('newClassModal');
  showNotification('Class created successfully!', 'success');
}

function addStudent() {
  const name = document.getElementById('studentName').value.trim();
  const points = parseInt(document.getElementById('initialPoints').value) || 0;
  const photoInput = document.getElementById('studentPhoto');
  let photoUrl = '';

  if (!name) {
    showNotification('Please enter a student name.', 'error');
    return;
  }

  if (photoInput.files[0]) {
    photoUrl = URL.createObjectURL(photoInput.files[0]);
  }

  const studentId = generateId();
  students[currentClassId].push({
    id: studentId,
    name,
    points,
    photo: photoUrl,
    rewards: [],
    instantRewards: []
  });
  userData[currentTeacherUsername].classes[currentClassId].students.push(studentId);
  updateStudentsView();
  updateLeaderboard();
  updateSettingsView();
  closeModal('addStudentModal');
  showNotification('Student added successfully!', 'success');
}

function addMultipleStudents() {
  const names = document.getElementById('multipleNames').value.split('\n').map(name => name.trim()).filter(name => name);
  if (names.length === 0) {
    showNotification('Please enter at least one student name.', 'error');
    return;
  }
  names.forEach(name => {
    const studentId = generateId();
    students[currentClassId].push({
      id: studentId,
      name,
      points: 0,
      photo: '',
      rewards: [],
      instantRewards: []
    });
    userData[currentTeacherUsername].classes[currentClassId].students.push(studentId);
  });
  updateStudentsView();
  updateLeaderboard();
  updateSettingsView();
  closeModal('addMultipleModal');
  showNotification(`${names.length} student(s) added successfully!`, 'success');
}

function updateStudentsView() {
  const grid = document.getElementById('studentsGrid');
  const list = document.getElementById('studentsList');
  grid.innerHTML = '<div class="student-card add-student-card" onclick="openAddStudentModal()"><div class="add-student-icon">➕</div><div>Add New Student</div></div>';
  list.innerHTML = '';

  (students[currentClassId] || []).forEach(student => {
    const isSelected = selectedStudents.has(student.id);
    // Grid view
    const card = document.createElement('div');
    card.className = `student-card ${isSelected ? 'selected' : ''}`;
    card.innerHTML = `
      <div class="student-avatar">${student.photo ? `<img src="${student.photo}" alt="${sanitizeHTML(student.name)}"/>` : student.name.charAt(0).toUpperCase()}</div>
      <div class="student-name">${sanitizeHTML(student.name)}</div>
      <div class="student-points">${student.points} points</div>
      <div class="student-rewards">${student.rewards.length} rewards</div>
      <div class="student-instant-rewards">${student.instantRewards.length} instant rewards</div>
    `;
    card.onclick = () => {
      if (bulkMode) {
        toggleStudentSelection(student.id, card);
      } else {
        openStudentPointsModal(student.id, 'add');
      }
    };
    grid.appendChild(card);

    // List view
    const listItem = document.createElement('div');
    listItem.className = `student-list-item ${isSelected ? 'selected' : ''}`;
    listItem.innerHTML = `
      <div class="student-list-avatar">${student.photo ? `<img src="${student.photo}" alt="${sanitizeHTML(student.name)}"/>` : student.name.charAt(0).toUpperCase()}</div>
      <div class="student-list-info">
        <div class="student-list-name">${sanitizeHTML(student.name)}</div>
        <div class="student-list-details">${student.rewards.length} rewards, ${student.instantRewards.length} instant rewards</div>
      </div>
      <div class="student-list-points">${student.points} points</div>
      <div class="student-list-actions">
        <button class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="event.stopPropagation(); openStudentPointsModal('${student.id}', 'add')">Add</button>
        <button class="btn btn-warning" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="event.stopPropagation(); openStudentPointsModal('${student.id}', 'subtract')">Subtract</button>
        <button class="btn btn-info" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="event.stopPropagation(); openEditStudentModal('${student.id}')">Edit</button>
      </div>
    `;
    if (bulkMode) {
      listItem.onclick = () => toggleStudentSelection(student.id, listItem);
    }
    list.appendChild(listItem);
  });
}

function toggleStudentSelection(studentId, element) {
  if (selectedStudents.has(studentId)) {
    selectedStudents.delete(studentId);
    element.classList.remove('selected');
  } else {
    selectedStudents.add(studentId);
    element.classList.add('selected');
  }
  updateSelectedCount();
}

function openStudentPointsModal(studentId, action) {
  currentStudentId = studentId;
  const student = students[currentClassId].find(s => s.id === studentId);
  document.getElementById('studentModalTitle').textContent = action === 'add' ? `Add Points for ${sanitizeHTML(student.name)}` : `Subtract Points from ${sanitizeHTML(student.name)}`;
  document.getElementById('pointsChange').value = '';
  document.getElementById('pointsReason').value = '';
  document.getElementById('studentPointsModal').classList.add('active');
}

function updateStudentPoints() {
  const points = parseInt(document.getElementById('pointsChange').value);
  const reason = document.getElementById('pointsReason').value.trim();
  if (!points || points < 1) {
    showNotification('Please enter a valid points amount.', 'error');
    return;
  }
  const student = students[currentClassId].find(s => s.id === currentStudentId);
  const action = document.getElementById('studentModalTitle').textContent.includes('Add') ? 'add' : 'subtract';
  const multiplier = powerups[currentClassId]?.find(p => p.active)?.multiplier || 1;
  const adjustedPoints = points * multiplier;

  if (action === 'add') {
    student.points += adjustedPoints;
  } else {
    student.points = Math.max(0, student.points - adjustedPoints);
  }

  history[currentClassId].push({
    studentId: currentStudentId,
    studentName: student.name,
    points: adjustedPoints,
    action,
    reason,
    timestamp: new Date().toISOString()
  });

  if (reason && !reasons[currentClassId].includes(reason)) {
    reasons[currentClassId].push(reason);
    updateReasonsList();
  }

  updateStudentsView();
  updateLeaderboard();
  updateSettingsView();
  closeModal('studentPointsModal');
  showNotification(`${action === 'add' ? 'Added' : 'Subtracted'} ${adjustedPoints} point(s) for ${sanitizeHTML(student.name)}.`, 'success');
}

function openEditStudentModal(studentId) {
  currentStudentId = studentId;
  const student = students[currentClassId].find(s => s.id === studentId);
  document.getElementById('editStudentName').value = student.name;
  const preview = document.getElementById('editPhotoPreview');
  const previewImg = document.getElementById('editPreviewImg');
  if (student.photo) {
    preview.style.display = 'block';
    previewImg.src = student.photo;
  } else {
    preview.style.display = 'none';
  }
  document.getElementById('editStudentModal').classList.add('active');
}

function updateStudent() {
  const name = document.getElementById('editStudentName').value.trim();
  const photoInput = document.getElementById('editStudentPhoto');
  if (!name) {
    showNotification('Please enter a student name.', 'error');
    return;
  }
  const student = students[currentClassId].find(s => s.id === currentStudentId);
  student.name = name;
  if (photoInput.files[0]) {
    student.photo = URL.createObjectURL(photoInput.files[0]);
  }
  updateStudentsView();
  updateLeaderboard();
  closeModal('editStudentModal');
  showNotification('Student updated successfully!', 'success');
}

function deleteStudent() {
  students[currentClassId] = students[currentClassId].filter(s => s.id !== currentStudentId);
  userData[currentTeacherUsername].classes[currentClassId].students = userData[currentTeacherUsername].classes[currentClassId].students.filter(id => id !== currentStudentId);
  history[currentClassId] = history[currentClassId].filter(h => h.studentId !== currentStudentId);
  updateStudentsView();
  updateLeaderboard();
  updateHistoryView();
  updateSettingsView();
  closeModal('editStudentModal');
  showNotification('Student deleted successfully!', 'success');
}

function openBulkPointsModal(action) {
  if (selectedStudents.size === 0) {
    showNotification('Please select at least one student.', 'error');
    return;
  }
  bulkAction = action;
  const points = parseInt(document.getElementById('bulkPointAmount').value);
  if (!points || points < 1) {
    showNotification('Please enter a valid points amount.', 'error');
    return;
  }
  document.getElementById('bulkModalTitle').textContent = action === 'add' ? 'Add Points' : 'Subtract Points';
  document.getElementById('bulkSummary').textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} ${points} point(s) to ${selectedStudents.size} student(s).`;
  document.getElementById('bulkReason').value = '';
  document.getElementById('bulkPointsModal').classList.add('active');
}

function confirmBulkPoints() {
  const points = parseInt(document.getElementById('bulkPointAmount').value);
  const reason = document.getElementById('bulkReason').value.trim();
  const multiplier = powerups[currentClassId]?.find(p => p.active)?.multiplier || 1;
  const adjustedPoints = points * multiplier;

  selectedStudents.forEach(studentId => {
    const student = students[currentClassId].find(s => s.id === studentId);
    if (bulkAction === 'add') {
      student.points += adjustedPoints;
    } else {
      student.points = Math.max(0, student.points - adjustedPoints);
    }
    history[currentClassId].push({
      studentId,
      studentName: student.name,
      points: adjustedPoints,
      action: bulkAction,
      reason,
      timestamp: new Date().toISOString()
    });
  });

  if (reason && !reasons[currentClassId].includes(reason)) {
    reasons[currentClassId].push(reason);
    updateReasonsList();
  }

  updateStudentsView();
  updateLeaderboard();
  updateSettingsView();
  closeModal('bulkPointsModal');
  exitBulkMode();
  showNotification(`${bulkAction === 'add' ? 'Added' : 'Subtracted'} ${adjustedPoints} point(s) for ${selectedStudents.size} student(s).`, 'success');
}

function updateLeaderboard() {
  const leaderboard = document.getElementById('leaderboard');
  leaderboard.innerHTML = '';
  const sortedStudents = [...(students[currentClassId] || [])].sort((a, b) => b.points - a.points);
  sortedStudents.forEach((student, index) => {
    const item = document.createElement('div');
    item.className = 'leaderboard-item';
    item.innerHTML = `
      <div class="leaderboard-rank ${index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : ''}">${index + 1}</div>
      <div class="leaderboard-avatar">${student.photo ? `<img src="${student.photo}" alt="${sanitizeHTML(student.name)}"/>` : student.name.charAt(0).toUpperCase()}</div>
      <div class="leaderboard-name">${sanitizeHTML(student.name)}</div>
      <div class="leaderboard-points">${student.points} points</div>
    `;
    leaderboard.appendChild(item);
  });
}

function createReward() {
  const title = document.getElementById('rewardTitle').value.trim();
  const description = document.getElementById('rewardDescription').value.trim();
  const points = selectedRewardType === 'points' ? parseInt(document.getElementById('rewardPoints').value) : 0;
  const icon = document.getElementById('rewardIcon').value.trim();

  if (!title || (selectedRewardType === 'points' && (!points || points < 1))) {
    showNotification('Please fill in all required fields.', 'error');
    return;
  }

  const rewardId = generateId();
  rewards[currentClassId].push({
    id: rewardId,
    title,
    description,
    points,
    type: selectedRewardType,
    icon
  });
  updateRewardsView();
  closeModal('createRewardModal');
  showNotification('Reward created successfully!', 'success');
}

function updateRewardsView() {
  const grid = document.getElementById('rewardsGrid');
  grid.innerHTML = '';
  (rewards[currentClassId] || []).forEach(reward => {
    const card = document.createElement('div');
    card.className = `reward-card ${reward.type}-reward`;
    card.innerHTML = `
      <div class="reward-type-badge ${reward.type}-badge">${reward.type.charAt(0).toUpperCase() + reward.type.slice(1)}</div>
      <div class="reward-header">
        <div>
          <div class="reward-title">${sanitizeHTML(reward.title)} ${reward.icon || ''}</div>
          ${reward.description ? `<div class="reward-description">${sanitizeHTML(reward.description)}</div>` : ''}
        </div>
        ${reward.type === 'points' ? `<div class="reward-points">${reward.points} points</div>` : ''}
      </div>
      <div class="reward-actions">
        <button class="btn btn-info" onclick="openEditRewardModal('${reward.id}')">Edit</button>
        <button class="btn btn-success" onclick="openClaimRewardModal('${reward.id}')">Claim</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

function openEditRewardModal(rewardId) {
  currentRewardId = rewardId;
  const reward = rewards[currentClassId].find(r => r.id === rewardId);
  document.getElementById('editRewardTitle').value = reward.title;
  document.getElementById('editRewardDescription').value = reward.description || '';
  document.getElementById('editRewardPoints').value = reward.points || '';
  document.getElementById('editRewardIcon').value = reward.icon || '';
  selectRewardType(reward.type, 'edit');
  document.getElementById('editRewardModal').classList.add('active');
}

function updateReward() {
  const title = document.getElementById('editRewardTitle').value.trim();
  const description = document.getElementById('editRewardDescription').value.trim();
  const points = selectedRewardType === 'points' ? parseInt(document.getElementById('editRewardPoints').value) : 0;
  const icon = document.getElementById('editRewardIcon').value.trim();

  if (!title || (selectedRewardType === 'points' && (!points || points < 1))) {
    showNotification('Please fill in all required fields.', 'error');
    return;
  }

  const reward = rewards[currentClassId].find(r => r.id === currentRewardId);
  reward.title = title;
  reward.description = description;
  reward.points = points;
  reward.type = selectedRewardType;
  reward.icon = icon;
  updateRewardsView();
  closeModal('editRewardModal');
  showNotification('Reward updated successfully!', 'success');
}

function deleteReward() {
  rewards[currentClassId] = rewards[currentClassId].filter(r => r.id !== currentRewardId);
  updateRewardsView();
  closeModal('editRewardModal');
  showNotification('Reward deleted successfully!', 'success');
}

function openClaimRewardModal(rewardId) {
  currentRewardId = rewardId;
  const reward = rewards[currentClassId].find(r => r.id === rewardId);
  const content = document.getElementById('claimRewardContent');
  content.innerHTML = `
    <p>Claim "${sanitizeHTML(reward.title)}" for:</p>
    <select id="claimStudentSelect" class="form-input">
      ${(students[currentClassId] || []).map(s => `<option value="${s.id}">${sanitizeHTML(s.name)} (${s.points} points)</option>`).join('')}
    </select>
    ${reward.type === 'points' ? `<p>Requires ${reward.points} points.</p>` : ''}
  `;
  document.getElementById('claimRewardModal').classList.add('active');
}

function confirmClaimReward() {
  const studentId = document.getElementById('claimStudentSelect').value;
  const reward = rewards[currentClassId].find(r => r.id === currentRewardId);
  const student = students[currentClassId].find(s => s.id === studentId);

  if (reward.type === 'points' && student.points < reward.points) {
    showNotification(`${sanitizeHTML(student.name)} does not have enough points.`, 'error');
    return;
  }

  if (reward.type === 'points') {
    student.points -= reward.points;
    student.rewards.push(reward.id);
  } else {
    student.instantRewards.push(reward.id);
  }

  history[currentClassId].push({
    studentId,
    studentName: student.name,
    rewardId: reward.id,
    rewardTitle: reward.title,
    action: 'claim',
    timestamp: new Date().toISOString()
  });

  updateStudentsView();
  updateLeaderboard();
  updateHistoryView();
  closeModal('claimRewardModal');
  showNotification(`Reward "${sanitizeHTML(reward.title)}" claimed for ${sanitizeHTML(student.name)}.`, 'success');
}

function updateHistoryView() {
  const list = document.getElementById('historyList');
  list.innerHTML = '';
  (history[currentClassId] || []).slice().reverse().forEach(entry => {
    const item = document.createElement('div');
    item.className = 'leaderboard-item';
    item.innerHTML = `
      <div class="leaderboard-name">${sanitizeHTML(entry.studentName)}</div>
      <div style="flex: 1;">
        ${entry.action === 'claim' ? 
          `Claimed "${sanitizeHTML(entry.rewardTitle)}"` : 
          `${entry.action === 'add' ? 'Added' : 'Subtracted'} ${entry.points} point(s) ${entry.reason ? `for "${sanitizeHTML(entry.reason)}"` : ''}`
        }
      </div>
      <div style="color: var(--text-secondary); font-size: 0.875rem;">${new Date(entry.timestamp).toLocaleString()}</div>
    `;
    list.appendChild(item);
  });
}

function exportHistory() {
  const data = (history[currentClassId] || []).map(entry => ({
    student: entry.studentName,
    action: entry.action,
    points: entry.points || null,
    reward: entry.rewardTitle || null,
    reason: entry.reason || null,
    timestamp: new Date(entry.timestamp).toLocaleString()
  }));
  const csv = 'Student,Action,Points,Reward,Reason,Timestamp\n' + 
    data.map(row => `${row.student},${row.action},${row.points || ''},${row.reward || ''},${row.reason || ''},${row.timestamp}`).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `history_${currentClassId}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function clearHistory() {
  history[currentClassId] = [];
  updateHistoryView();
  showNotification('History cleared successfully!', 'success');
}

function updateSettingsView() {
  document.getElementById('currentClassName').textContent = classes.find(c => c.id === currentClassId)?.name || '';
  document.getElementById('totalStudents').textContent = (students[currentClassId] || []).length;
  document.getElementById('totalPoints').textContent = (students[currentClassId] || []).reduce((sum, s) => sum + s.points, 0);
  updateReasonsList();
}

function updateReasonsList() {
  const reasonsList = document.getElementById('reasonsList');
  const savedReasons = document.getElementById('savedReasonsList');
  reasonsList.innerHTML = '';
  savedReasons.innerHTML = '';
  (reasons[currentClassId] || []).forEach(reason => {
    reasonsList.innerHTML += `<option value="${sanitizeHTML(reason)}">${sanitizeHTML(reason)}</option>`;
    const chip = document.createElement('span');
    chip.style.padding = '0.25rem 0.75rem';
    chip.style.background = 'var(--surface-secondary)';
    chip.style.borderRadius = '12px';
    chip.style.fontSize = '0.875rem';
    chip.style.display = 'inline-flex';
    chip.style.alignItems = 'center';
    chip.style.gap = '0.5rem';
    chip.innerHTML = `${sanitizeHTML(reason)} <button class="btn btn-danger" style="padding: 0.1rem 0.5rem; font-size: 0.75rem;" onclick="deleteReason('${reason}')">X</button>`;
    savedReasons.appendChild(chip);
  });
}

function deleteReason(reason) {
  reasons[currentClassId] = reasons[currentClassId].filter(r => r !== reason);
  updateReasonsList();
  showNotification('Reason deleted successfully!', 'success');
}

function resetAllPoints() {
  (students[currentClassId] || []).forEach(student => {
    student.points = 0;
  });
  history[currentClassId].push({
    action: 'reset',
    timestamp: new Date().toISOString()
  });
  updateStudentsView();
  updateLeaderboard();
  updateSettingsView();
  showNotification('All points reset successfully!', 'success');
}

function backupClassData() {
  const data = {
    class: classes.find(c => c.id === currentClassId),
    students: students[currentClassId],
    history: history[currentClassId],
    rewards: rewards[currentClassId],
    powerups: powerups[currentClassId],
    reasons: reasons[currentClassId]
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `backup_${currentClassId}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showNotification('Data backed up successfully!', 'success');
}

function deleteCurrentClass() {
  userData[currentTeacherUsername].classes[currentClassId] = null;
  currentUser.classes = currentUser.classes.filter(id => id !== currentClassId);
  delete students[currentClassId];
  delete rewards[currentClassId];
  delete history[currentClassId];
  delete powerups[currentClassId];
  delete reasons[currentClassId];
  classes = currentUser.classes.map(id => userData[currentTeacherUsername].classes[id]);
  currentClassId = classes[0]?.id || null;
  updateClassSelector();
  updateStudentsView();
  updateLeaderboard();
  updateRewardsView();
  updateHistoryView();
  updateSettingsView();
  updatePowerUpsView();
  showNotification('Class deleted successfully!', 'success');
}

function createPowerUp() {
  const title = document.getElementById('powerUpTitle').value.trim();
  const description = document.getElementById('powerUpDescription').value.trim();
  const multiplier = parseFloat(document.getElementById('powerUpMultiplier').value);
  const duration = parseInt(document.getElementById('powerUpDuration').value);

  if (!title || !multiplier || !duration) {
    showNotification('Please fill in all required fields.', 'error');
    return;
  }

  const powerUpId = generateId();
  powerups[currentClassId].push({
    id: powerUpId,
    title,
    description,
    multiplier,
    duration,
    active: true,
    startDate: new Date().toISOString()
  });
  updatePowerUpsView();
  closeModal('createPowerUpModal');
  showNotification('Power Up created successfully!', 'success');
}

function updatePowerUpsView() {
  const grid = document.getElementById('powerupsGrid');
  grid.innerHTML = '';
  (powerups[currentClassId] || []).forEach(powerup => {
    const card = document.createElement('div');
    card.className = 'reward-card';
    card.innerHTML = `
      <div class="reward-header">
        <div>
          <div class="reward-title">${sanitizeHTML(powerup.title)}</div>
          ${powerup.description ? `<div class="reward-description">${sanitizeHTML(powerup.description)}</div>` : ''}
          <div>Multiplier: ${powerup.multiplier}x</div>
          <div>Duration: ${powerup.duration} days</div>
          <div>Status: ${powerup.active ? 'Active' : 'Inactive'}</div>
        </div>
      </div>
      <div class="reward-actions">
        <button class="btn btn-info" onclick="openEditPowerUpModal('${powerup.id}')">Edit</button>
        <button class="btn ${powerup.active ? 'btn-warning' : 'btn-success'}" onclick="togglePowerUp('${powerup.id}')">${powerup.active ? 'Deactivate' : 'Activate'}</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

function openEditPowerUpModal(powerUpId) {
  currentPowerUpId = powerUpId;
  const powerup = powerups[currentClassId].find(p => p.id === powerUpId);
  document.getElementById('editPowerUpTitle').value = powerup.title;
  document.getElementById('editPowerUpDescription').value = powerup.description || '';
  document.getElementById('editPowerUpMultiplier').value = powerup.multiplier;
  document.getElementById('editPowerUpDuration').value = powerup.duration;
  document.getElementById('editPowerUpModal').classList.add('active');
}

function updatePowerUp() {
  const title = document.getElementById('editPowerUpTitle').value.trim();
  const description = document.getElementById('editPowerUpDescription').value.trim();
  const multiplier = parseFloat(document.getElementById('editPowerUpMultiplier').value);
  const duration = parseInt(document.getElementById('editPowerUpDuration').value);

  if (!title || !multiplier || !duration) {
    showNotification('Please fill in all required fields.', 'error');
    return;
  }

  const powerup = powerups[currentClassId].find(p => p.id === currentPowerUpId);
  powerup.title = title;
  powerup.description = description;
  powerup.multiplier = multiplier;
  powerup.duration = duration;
  updatePowerUpsView();
  closeModal('editPowerUpModal');
  showNotification('Power Up updated successfully!', 'success');
}

function deletePowerUp() {
  powerups[currentClassId] = powerups[currentClassId].filter(p => p.id !== currentPowerUpId);
  updatePowerUpsView();
  closeModal('editPowerUpModal');
  showNotification('Power Up deleted successfully!', 'success');
}

function togglePowerUp(powerUpId) {
  const powerup = powerups[currentClassId].find(p => p.id === powerUpId);
  powerup.active = !powerup.active;
  if (powerup.active) {
    powerup.startDate = new Date().toISOString();
  }
  updatePowerUpsView();
  showNotification(`Power Up ${powerup.active ? 'activated' : 'deactivated'} successfully!`, 'success');
}

function showAdminView() {
  switchView('admin-classes');
  const adminView = document.getElementById('admin-classesView');
  adminView.innerHTML = `
    <div class="admin-header">
      <div class="admin-title">🏫 School Management</div>
      <p style="color: var(--text-secondary); margin-bottom: 1rem;">Manage classes and teachers for ${sanitizeHTML(currentUser.school)}</p>
      <div class="admin-controls">
        <button class="btn btn-primary" onclick="openCreateClassModal()">Create Class</button>
      </div>
    </div>
    <div class="admin-content">
      <h3 style="margin-bottom: 1rem;">School Statistics</h3>
      <div class="admin-stats">
        <div class="stat-card">
          <div class="stat-value">${Object.keys(userData).filter(u => users[u].school === currentUser.school).length}</div>
          <div class="stat-label">Teachers</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${Object.values(userData).reduce((sum, u) => sum + Object.keys(u.classes).length, 0)}</div>
          <div class="stat-label">Classes</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${Object.values(userData).reduce((sum, u) => sum + Object.values(u.classes).reduce((s, c) => s + c.students.length, 0), 0)}</div>
          <div class="stat-label">Students</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${Object.values(userData).reduce((sum, u) => sum + Object.values(u.classes).reduce((s, c) => s + c.students.reduce((p, sid) => p + (students[c.id]?.find(s => s.id === sid)?.points || 0), 0), 0), 0)}</div>
          <div class="stat-label">Total Points</div>
        </div>
      </div>
      <h3 style="margin-bottom: 1rem;">Classes</h3>
      <div id="adminClassesList"></div>
    </div>
  `;
  updateAdminClassesList();
}

function openCreateClassModal() {
  document.getElementById('createClassModal').classList.add('active');
  document.getElementById('adminClassName').value = '';
  document.getElementById('teacherUsername').value = '';
  document.getElementById('teacherPassword').value = '';
}

function createClassAsAdmin() {
  const className = document.getElementById('adminClassName').value.trim();
  const username = document.getElementById('teacherUsername').value.trim();
  const password = document.getElementById('teacherPassword').value;

  if (!className || !username || !password) {
    showNotification('Please fill in all fields.', 'error');
    return;
  }

  if (users[username]) {
    showNotification('Teacher username already exists.', 'error');
    return;
  }

  const classId = generateId();
  users[username] = {
    password,
    school: currentUser.school,
    type: 'personal',
    classes: [classId]
  };
  userData[username] = {
    classes: {
      [classId]: {
        id: classId,
        name: className,
        students: [],
        rewards: [],
        history: [],
        powerups: [],
        reasons: []
      }
    }
  };
  students[classId] = [];
  rewards[classId] = [];
  history[classId] = [];
  powerups[classId] = [];
  reasons[classId] = [];
  schools[currentUser.school].classes.push(classId);
  updateAdminClassesList();
  closeModal('createClassModal');
  showNotification('Class and teacher account created successfully!', 'success');
}

function updateAdminClassesList() {
  const list = document.getElementById('adminClassesList');
  list.innerHTML = '';
  const schoolClasses = Object.values(userData).flatMap(u => Object.values(u.classes).filter(c => schools[currentUser.school].classes.includes(c.id)));
  schoolClasses.forEach(cls => {
    const teacher = Object.keys(users).find(u => users[u].classes.includes(cls.id));
    const card = document.createElement('div');
    card.className = 'class-detail-card';
    card.innerHTML = `
      <div class="class-detail-header">
        <div>
          <div class="class-detail-title">${sanitizeHTML(cls.name)}</div>
          <div class="class-detail-teacher">Teacher: ${sanitizeHTML(teacher)}</div>
        </div>
        <button class="btn btn-info" onclick="openClassDetailModal('${cls.id}')">View Details</button>
      </div>
    `;
    list.appendChild(card);
  });
}

function openClassDetailModal(classId) {
  currentClassId = classId;
  const cls = Object.values(userData).flatMap(u => Object.values(u.classes)).find(c => c.id === classId);
  const teacher = Object.keys(users).find(u => users[u].classes.includes(classId));
  const content = document.getElementById('classDetailContent');
  content.innerHTML = `
    <div class="class-detail-card">
      <div class="class-detail-title">${sanitizeHTML(cls.name)}</div>
      <div class="class-detail-teacher">Teacher: ${sanitizeHTML(teacher)}</div>
      <div class="class-stats">
        <div class="class-stat">
          <div class="class-stat-value">${(students[classId] || []).length}</div>
          <div class="class-stat-label">Students</div>
        </div>
        <div class="class-stat">
          <div class="class-stat-value">${(students[classId] || []).reduce((sum, s) => sum + s.points, 0)}</div>
          <div class="class-stat-label">Total Points</div>
        </div>
        <div class="class-stat">
          <div class="class-stat-value">${(rewards[classId] || []).length}</div>
          <div class="class-stat-label">Rewards</div>
        </div>
        <div class="class-stat">
          <div class="class-stat-value">${(history[classId] || []).length}</div>
          <div class="class-stat-label">History Entries</div>
        </div>
      </div>
      <h3 style="margin-bottom: 1rem;">Students</h3>
      <table class="students-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Points</th>
            <th>Rewards</th>
            <th>Instant Rewards</th>
          </tr>
        </thead>
        <tbody>
          ${(students[classId] || []).map(s => `
            <tr>
              <td>${sanitizeHTML(s.name)}</td>
              <td>${s.points}</td>
              <td>${s.rewards.length}</td>
              <td>${s.instantRewards.length}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
  document.getElementById('deleteClassBtn').onclick = () => deleteClassFromDetail(classId);
  document.getElementById('classDetailModal').classList.add('active');
}

function deleteClassFromDetail(classId) {
  const teacher = Object.keys(users).find(u => users[u].classes.includes(classId));
  users[teacher].classes = users[teacher].classes.filter(id => id !== classId);
  delete userData[teacher].classes[classId];
  schools[currentUser.school].classes = schools[currentUser.school].classes.filter(id => id !== classId);
  delete students[classId];
  delete rewards[classId];
  delete history[classId];
  delete powerups[classId];
  delete reasons[classId];
  updateAdminClassesList();
  closeModal('classDetailModal');
  showNotification('Class deleted successfully!', 'success');
}

function updateAdminTeachersList() {
  const adminView = document.getElementById('admin-teachersView');
  adminView.innerHTML = `
    <div class="admin-header">
      <div class="admin-title">👨‍🏫 Teachers</div>
      <p style="color: var(--text-secondary); margin-bottom: 1rem;">Manage teacher accounts for ${sanitizeHTML(currentUser.school)}</p>
    </div>
    <div class="admin-content">
      <div id="adminTeachersList"></div>
    </div>
  `;
  const list = document.getElementById('adminTeachersList');
  list.innerHTML = '';
  Object.entries(users).filter(([_, u]) => u.school === currentUser.school && u.type === 'personal').forEach(([username, user]) => {
    const card = document.createElement('div');
    card.className = 'class-detail-card';
    card.innerHTML = `
      <div class="class-detail-header">
        <div>
          <div class="class-detail-title">${sanitizeHTML(username)}</div>
          <div class="class-detail-teacher">Classes: ${user.classes.length}</div>
        </div>
        <button class="btn btn-info" onclick="openEditTeacherModal('${username}')">Edit</button>
      </div>
    `;
    list.appendChild(card);
  });
}

function openEditTeacherModal(username) {
  currentTeacherUsername = username;
  document.getElementById('editTeacherUsername').value = username;
  document.getElementById('editTeacherPassword').value = '';
  document.getElementById('editTeacherConfirmPassword').value = '';
  document.getElementById('editTeacherModal').classList.add('active');
}

function updateTeacher() {
  const password = document.getElementById('editTeacherPassword').value;
  const confirmPassword = document.getElementById('editTeacherConfirmPassword').value;

  if (password && password !== confirmPassword) {
    showNotification('Passwords do not match.', 'error');
    return;
  }

  if (password) {
    users[currentTeacherUsername].password = password;
  }
  closeModal('editTeacherModal');
  showNotification('Teacher updated successfully!', 'success');
}

function updateAdminEmbedsList() {
  const adminView = document.getElementById('admin-embedsView');
  adminView.innerHTML = `
    <div class="admin-header">
      <div class="admin-title">🔗 Embeds</div>
      <p style="color: var(--text-secondary); margin-bottom: 1rem;">Manage embeds for ${sanitizeHTML(currentUser.school)}</p>
      <div class="admin-controls">
        <button class="btn btn-primary" onclick="openAddEmbedModal()">Add Embed</button>
      </div>
    </div>
    <div class="admin-content">
      <div id="adminEmbedsList"></div>
    </div>
  `;
  updateEmbedsList();
}

function openAddEmbedModal() {
  document.getElementById('embedName').value = '';
  document.getElementById('embedUrl').value = '';
  document.getElementById('addEmbedModal').classList.add('active');
}

function addEmbed() {
  const name = document.getElementById('embedName').value.trim();
  const url = document.getElementById('embedUrl').value.trim();

  if (!name || !url) {
    showNotification('Please fill in all fields.', 'error');
    return;
  }

  const embedId = generateId();
  schools[currentUser.school].embeds = schools[currentUser.school].embeds || [];
  schools[currentUser.school].embeds.push({ id: embedId, name, url });
  updateEmbedsList();
  closeModal('addEmbedModal');
  showNotification('Embed added successfully!', 'success');
}

function updateEmbedsList() {
  const list = document.getElementById('embedsList');
  list.innerHTML = '';
  (schools[currentUser.school].embeds || []).forEach(embed => {
    const card = document.createElement('div');
    card.className = 'class-detail-card embed-container';
    card.innerHTML = `
      <div class="class-detail-header">
        <div>
          <div class="class-detail-title">${sanitizeHTML(embed.name)}</div>
          <div class="class-detail-teacher"><a href="${sanitizeHTML(embed.url)}" target="_blank">${sanitizeHTML(embed.url)}</a></div>
        </div>
        ${currentUser.type === 'admin' ? `<button class="btn btn-danger" onclick="deleteEmbed('${embed.id}')">Delete</button>` : ''}
      </div>
      <iframe src="${sanitizeHTML(embed.url)}" style="width: 100%; height: 400px; border: none; border-radius: 8px;"></iframe>
      <button class="fullscreen-button" onclick="toggleFullscreen(this.parentElement)">Fullscreen</button>
    `;
    list.appendChild(card);
  });
}

function deleteEmbed(embedId) {
  schools[currentUser.school].embeds = schools[currentUser.school].embeds.filter(e => e.id !== embedId);
  updateEmbedsList();
  showNotification('Embed deleted successfully!', 'success');
}

function toggleFullscreen(container) {
  container.classList.toggle('fullscreen');
}

function copyClassName() {
  const className = classes.find(c => c.id === currentClassId)?.name || '';
  navigator.clipboard.writeText(className);
  showNotification('Class name copied to clipboard!', 'success');
}

function onSearchChange() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  const filteredStudents = (students[currentClassId] || []).filter(s => s.name.toLowerCase().includes(query));
  students[currentClassId] = filteredStudents;
  updateStudentsView();
  students[currentClassId] = userData[currentTeacherUsername].classes[currentClassId].students.map(id => students[currentClassId].find(s => s.id === id) || students[currentClassId].find(s => s.id === id));
}

document.getElementById('loginBtn').onclick = login;
document.getElementById('signupBtn').onclick = signup;

document.getElementById('studentPhoto').addEventListener('change', (e) => {
  if (e.target.files[0]) {
    document.getElementById('photoPreview').style.display = 'block';
    document.getElementById('previewImg').src = URL.createObjectURL(e.target.files[0]);
  }
});

document.getElementById('editStudentPhoto').addEventListener('change', (e) => {
  if (e.target.files[0]) {
    document.getElementById('editPhotoPreview').style.display = 'block';
    document.getElementById('editPreviewImg').src = URL.createObjectURL(e.target.files[0]);
  }
});

['studentPhoto', 'editStudentPhoto'].forEach(id => {
  const uploadArea = document.querySelector(`#${id} ~ .upload-area`);
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });
  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      document.getElementById(id).files = e.dataTransfer.files;
      const previewId = id === 'studentPhoto' ? 'photoPreview' : 'editPhotoPreview';
      const previewImgId = id === 'studentPhoto' ? 'previewImg' : 'editPreviewImg';
      document.getElementById(previewId).style.display = 'block';
      document.getElementById(previewImgId).src = URL.createObjectURL(file);
    }
  });
});
</script>
</body>
</html>
